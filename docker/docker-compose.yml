version: '3.3'
services: 
  gitlab:
    image: 'gitlab/gitlab-ce:11.11.8-ce.0'
    volumes: 
      - ./gitlab/config:/etc/gitlab
      - ./gitlab/logs:/var/log/gitlab
      - ./gitlab/data:/var/opt/gitlab
    ports: 
      - 1080:80
      - 1022:22
    restart: unless-stopped

  jenkins:
    image: 'jenkinsci/blueocean'
    user: root
    volumes: 
      - ./jenkins:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    ports: 
      - 2080:8080
    restart: unless-stopped

  sonarqube:
    image: 'sonarqube:7.9.1-community'
    volumes:
      - ./sonarqube/extensions:/opt/sonarqube/extensions
      - ./sonarqube/temp:/opt/sonarqube/temp
    ports:
      - 3080:9000
    restart: unless-stopped

  awx_web:
    image: 'ansible/awx_web:3.0.1'
    depends_on:
     - rabbitmq
     - memcached
     - postgres
    ports:
     - 4080:8052
    user: root
    restart: unless-stopped
    environment:
      http_proxy:
      https_proxy:
      no_proxy:
      SECRET_KEY: awxsecret
      DATABASE_NAME: awx
      DATABASE_USER: awx
      DATABASE_PASSWORD: awxpass
      DATABASE_PORT: 5432
      DATABASE_HOST: postgres
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      RABBITMQ_PORT: 5672
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_VHOST: awx
      MEMCACHED_HOST: memcached
      MEMCACHED_PORT: 11211
      AWX_ADMIN_USER: root
      AWX_ADMIN_PASSWORD: master
  
  awx_task:
    image: 'ansible/awx_task:3.0.1'
    depends_on:
     - rabbitmq
     - memcached
     - awx_web
     - postgres
    hostname: awx
    user: root
    restart: unless-stopped
    environment:
      http_proxy:
      https_proxy:
      no_proxy:
      SECRET_KEY: awxsecret
      DATABASE_NAME: awx
      DATABASE_USER: awx
      DATABASE_PASSWORD: awxpass
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      RABBITMQ_USER: guest
      RABBITMQ_PASSWORD: guest
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_VHOST: awx
      MEMCACHED_HOST: memcached
      MEMCACHED_PORT: 11211
      AWX_ADMIN_USER: root
      AWX_ADMIN_PASSWORD: master

  rabbitmq:
    image: 'ansible/awx_rabbitmq:3.7.4'
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_VHOST: awx
      RABBITMQ_ERLANG_COOKIE: cookiemonster

  memcached:
    image: 'memcached:alpine'
    restart: unless-stopped

  postgres:
    image: 'postgres:9.6'
    restart: unless-stopped
    volumes:
     - ./awx:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: awx
      POSTGRES_PASSWORD: awxpass
      POSTGRES_DB: awx
      PGDATA: /var/lib/postgresql/data/pgdata

networks:
  default:
    external:
      name: cicd
